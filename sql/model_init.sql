
--DROP TABLE historial_estado_usuario CASCADE CONSTRAINTS;
--DROP TABLE tokens CASCADE CONSTRAINTS;
--DROP TABLE usuarios CASCADE CONSTRAINTS;


-- CREACIÃ“N DE TABLAS BASE
-- ==========================

-- Tabla: USUARIOS
CREATE TABLE usuarios (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(100 CHAR) NOT NULL,
    email VARCHAR2(100 CHAR) NOT NULL UNIQUE,
    password VARCHAR2(200 CHAR) NOT NULL,
    tipo_usuario VARCHAR2(20 CHAR) NOT NULL,
    estado VARCHAR2(20 CHAR) DEFAULT 'PENDIENTE' NOT NULL,
    fecha_nacimiento DATE,
    documento_identidad VARCHAR2(20 CHAR),
    telefono VARCHAR2(20 CHAR),
    direccion VARCHAR2(200 CHAR),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- restricciones CHECK separadas
    CONSTRAINT chk_tipo_usuario CHECK (tipo_usuario IN ('ESTUDIANTE', 'DOCENTE')),
    CONSTRAINT chk_estado CHECK (estado IN ('PENDIENTE', 'ACTIVO', 'RECHAZADO'))
);

COMMIT;


-- Tabla: TOKENS
CREATE TABLE tokens (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    usuario_id NUMBER NOT NULL,
    token VARCHAR2(500 CHAR) NOT NULL,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_expiracion TIMESTAMP,
    valido CHAR(1) DEFAULT 'S' NOT NULL,

    -- Restricciones
    CONSTRAINT chk_valido CHECK (valido IN ('S', 'N')),
    CONSTRAINT fk_tokens_usuario FOREIGN KEY (usuario_id)
        REFERENCES usuarios(id) ON DELETE CASCADE
);

COMMIT;


CREATE TABLE historial_estado_usuario (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    usuario_id NUMBER NOT NULL,
    estado_anterior VARCHAR2(20 CHAR),
    estado_nuevo VARCHAR2(20 CHAR) NOT NULL,
    observacion CLOB,
    fecha_cambio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cambiado_por NUMBER,

    CONSTRAINT fk_historial_usuario FOREIGN KEY (usuario_id)
        REFERENCES usuarios(id) ON DELETE CASCADE,

    CONSTRAINT fk_historial_admin FOREIGN KEY (cambiado_por)
        REFERENCES usuarios(id) -- sin ON DELETE CASCADE, solo referencia simple
);

COMMIT;
